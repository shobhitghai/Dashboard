(function() {
    app['filter-panel'] = {
        settings: {
            target: '.mod-filter-panel'
        },
        init: function(isSectionSpecific, target, fetchCallback) {
            if(isSectionSpecific == true && target){
                this.settings.target = target;
            }else{
                app['filter-panel'].fetchData();
            }
            var s = this.settings;
            app['filter-panel'].selectionHandler(isSectionSpecific, fetchCallback);

        },
        fetchData: function(url, storeDropdown) {
            var self = this;

            function successCallback(res) {
                var res = $.parseJSON(res);
                console.log(res)
                self.response = res;
                app['filter-panel'].renderList(res, '');
                app['filter-panel'].filterListSelection(res);
            }

            function errorCallback(err) {
                console.log(err);
            }

            $.ajax({
                url: hostUrl + 'getStoreDetails',
                success: function(res) {
                    successCallback(res);
                },
                error: function(err) {
                    errorCallback(err);
                }
            })

        },
        renderList: function(res, listType) {
            var s = this.settings;
            var cityContainer = $(s.target).find('#city-dd');
            var storeContainer = $(s.target).find('#name-dd');
            var brandContainer = $(s.target).find('#brand-dd');

            var cityArray = new Array();
            var storeArray = new Array();
            var brandArray = new Array();

            $.each(res, function(i, v) {
                cityArray.push(this.city);
                storeArray.push(this.name);
                brandArray.push(this.brand_name);
            })

            cityArray = cityArray.getUnique();
            storeArray = storeArray.getUnique();
            brandArray = brandArray.getUnique();

            if (listType != 'city')
                app['filter-panel'].appendList(cityArray, cityContainer, 'city', 'by city');

            if (listType != 'name')
                app['filter-panel'].appendList(storeArray, storeContainer, 'name', 'by store');

            if (listType != 'brand_name')
                app['filter-panel'].appendList(brandArray, brandContainer, 'brand_name', 'by brand');

        },
        selectionHandler: function(isSectionSpecific, fetchCallback) {
            var self = this;
            var s = this.settings;
            var panel = $(s.target);

            panel.find('.btn-filter').on('click', function() {
                var selectedCityArr = [];
                var selectedStoreArr = [];
                var selectedBrandArr = [];

                var selection = $('.lbjs-item[selected=selected]');

                $.each(selection, function(i, v) {
                    if ($(this).data('list-type') == 'city') {
                        selectedCityArr.push($(this).text());
                    } else if ($(this).data('list-type') == 'name') {
                        selectedStoreArr.push(app['filter-panel'].getStoreId($(this).text()));
                    } else if ($(this).data('list-type') == 'brand_name') {
                        selectedBrandArr.push(app['filter-panel'].getBrandId($(this).text()));
                    }
                });

                window.filterParamObj = {
                    storeId: selectedStoreArr,
                    city: selectedCityArr,
                    brandId: selectedBrandArr
                }

                if(isSectionSpecific == true){
                    window.trendSectionObj = {
                        storeId: selectedStoreArr,
                        city: selectedCityArr,
                        brandId: selectedBrandArr
                    }

                    fetchCallback();
                } else{
                    $.each(app, function(module, v) {
                        if (app[module].refreshData) {
                            app[module].refreshData();
                        }
                    })    
                }

            });

            panel.find('.btn-reset-filter').on('click', function() {
                panel.find('.lbjs').remove();
                panel.find('.modal-body select option').remove();
                app['filter-panel'].renderList(self.response, '');
                app['filter-panel'].filterListSelection(self.response);
            });

        },
        appendList: function(arrayList, container, listType, searchText) {
            $.each(arrayList, function(i, val) {
                container.append('<option>' + val + '</option>');
            });

            container.listbox({
                'searchbar': true,
                'listType': listType,
                'searchText': searchText
            });
        },
        filterListSelection: function(res) {
            var obj = new Array();

            $('.lbjs-item').on('click', function() {
                if (!($(this).attr('disabled') == 'disabled')) {
                    var self = this;

                    // $(self).attr('data-selected', true);

                    if ($(self).attr('selected')) {
                        $(self).attr('data-selected', true);
                        // $(self).attr('data-disabled', false);
                    } else {
                        $(self).attr('data-selected', false);
                    }

                    var type = $(self).attr('data-list-Type');
                    var value = $(self).text();

                    $.each(res, function(i, v) {
                        if (this[type] === value) {
                            if ($(self).attr('selected')) {
                                obj.push(this);
                            } else {
                                obj.pop(this);
                            }
                        }
                    })

                    console.log(obj, type);
                    app['filter-panel'].enableDisableListSelection(obj, type);
                }

            });
        },
        enableDisableListSelection: function(obj, type) {
            function disbaleItem(key) {
                $.each($('.lbjs-item[data-list-type =' + key + ']'), function(i, v) {
                    var self = this;
                    // if (!$(self).attr('data-selected')) {
                    // $(self).attr('data-disabled', true);
                    $(self).attr('disabled', true);

                    // }

                    $.each(obj, function(ind, val) {
                        if ($(self).text() === this[key]) {
                            // $(self).attr('data-disabled', false);
                            $(self).attr('disabled', false);
                            $(self).attr('data-selected', true);
                        };
                    })
                })
            }

            if (type == 'city') {
                disbaleItem('name');
                disbaleItem('brand_name');
            }

            if (type == 'name') {
                disbaleItem('city');
                disbaleItem('brand_name');
            }

            if (type == 'brand_name') {
                disbaleItem('city');
                disbaleItem('name');
            }
        },
        getStoreId: function(name) {
            var self = this;
            var id;
            $.each(self.response, function(i, v) {
                if (this['name'] == name) {
                    id = this['store_id'];
                    return false;
                }
            });

            return id;
        },
        getBrandId: function(brand) {
            var self = this;
            var id;
            $.each(self.response, function(i, v) {
                if (this['brand_name'] == brand) {
                    id = this['brand_id'];
                    return false;
                }
            });

            return id;
        }
    }
})(app);